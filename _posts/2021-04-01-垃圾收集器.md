---
layout:     post
title:      垃圾收集器总结
subtitle:   概述
date:       2021-04-01
author:     QuanLi
header-img: img/post-bg-kuaidi.jpg
catalog: true
tags:
    - JVM
---

# 垃圾收集器总结

### 垃圾回收算法

垃圾回收算法有标记清除、标记复制、标记整理和分代回收。新生代可以用标记复制，因为每次都有大量对象死亡，只要付出少量复制的代价，老年代存活率比较高，可以用标记清除或者标记整理。

- **标记清除**：主要缺点有两个一个是，如果堆中对象大部分都是要回收的，要进行大量标记清除的操作，效率很低。另一个是标记清除会产生大量碎片
- **标记复制**：缺点是空间浪费和存活率高时会进行大量复制操作，效率降低
- **标记整理**：让所有存活对象朝内存空间一端移动，然后清理掉 边界以外内存，

### 垃圾收集器

垃圾收集器是对垃圾收集算法的具体实现。没有完美的垃圾收集器，要根据场景选择使用合适的垃圾收集器。

![image-20210401211750086](C:\Users\ql\AppData\Roaming\Typora\typora-user-images\image-20210401211750086.png)

### Serial

​	最基本，历史最悠久的垃圾收集器，采用**标记复制**算法，**单线程**，**垃圾回收时要暂停所有其他工作线程**，会给用户带来恶劣体验。

### ParNew

​	是Serial收集器的多线程版本，也是**标记复制**，**多线程并行垃圾回收**，但是GC时还是要**暂停其他工作线程**

它是目前新生代首选的垃圾回收器，能**与老年代CMS配合工作的**。

### Parallel Scavenge

​	同样基于**标记复制**，**也是多线程并行垃圾回收**，它十分注重**吞吐量**，所谓吞吐量就是运行用户代码的时间除以总消耗时间。无法和CMS配合，JDK1.6后才出现Parallel Old

### Serial old

是Serial的老年代版本，同样是**单线程**，使用**标记整理**，在JDK1.5及之前的版本中与Parallel Scavenge收集器搭配使用

### Parallel Old

​	Parallel Scavenge的老年代版本，基于**标记整理**，**支持多线程并发收集**。

### CMS

​	**响应速度优先**，适合B/S系统的服务端，使用**标记清除**，**CMS做到了垃圾回收和用户线程一起执行**，但是因为占用了一部分线程会导致吞吐量下降。无法处理**浮动垃圾**（GC时用户产生的新垃圾）。CMS并不是独占的回收器，也就说CMS回收的过程中，应用程序仍然在不停的工作，又会有新的垃圾不断的产生，**所以在使用CMS的过程中应该确保应用程序的内存足够可用。**

​	如果内存使用率增长的很快，在CMS执行的过程中，已经出现了内存不足的情况，此时CMS回收就会失败，虚拟机将启动老年代`串行`回收器；`SerialOldGC`进行垃圾回收，这会导致应用程序中断，直到垃圾回收完成后才会正常工作。

### **堆内存垃圾收集器：**G1

​	G1 收集器是 jdk1.7 才正式引用的商用收集器，现在已经成为 jdk9 默认的收集器。前面几款收集器收集的范围都是新生代或者老年代，**G1 进行垃圾收集的范围是整个堆内存**

​	它采用 “ **化整为零** ” 的思路，**把整个堆内存划分为多个大小相等的独立区域（Region）**，在 G1 收集器中还保留着新生代和老年代的概念，它们分别都是一部分 Region。

![image-20210401215113963](C:\Users\ql\AppData\Roaming\Typora\typora-user-images\image-20210401215113963.png)

​	**每一个方块就是一个区域，每个区域可能是 Eden、Survivor、老年代，每种区域的数量也不一定。**跟踪每个区域垃圾回收价值大小，后台维护一个优先级列表，根据用户允许的垃圾收集停顿时间有优先级地去回收。

​	在每个 Region 中，都有**一个 Remembered Set 来实时记录该区域内的引用类型数据与其他区域数据的引用关系**（在前面的几款分代收集中，新生代、老年代中也有一个 Remembered Set 来**实时记录与其他区域的引用关系**），在标记时直接参考这些引用关系就可以知道这些对象是否应该被清除，而不用扫描全堆的数据。

​	G1 收集器可以 “ **建立可预测的停顿时间模型** ”，它维护了一个列表用于记录每个 Region 回收的价值大小（回收后获得的空间大小以及回收所需时间的经验值），这样可以保证 G1 收集器在有限的时间内可以获得最大的回收效率。
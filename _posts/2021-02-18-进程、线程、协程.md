---
layout:     post
title:      进程、线程、协程
subtitle:   概述
date:       2021-02-18
author:     QuanLi
header-img: img/post-bg-kuaidi.jpg
catalog: true
tags:
    - 多线程
---

# 进程、线程、协程

### 线程的实现

##### 内核线程实现

​	内核线程就是由操作系统内核支持的线程，这种线程由内核来完成线程切换，由内核对线程进行调度，并将线程的任务映射到各个处理器上，也称为1：1实现。

​	因为是基于内核线程实现的，各种线程操作，如创建、构析和同步，都要进行系统调用。而系统调用代价高昂，需要在用户态和内核态中来回切换。

##### 用户线程实现

​	使用用户线程实现的方式被称为1：N实现。这种线程完全建立在用户空间的线程库上，不需要切换到内核态，非常快且低消耗。

​	用户线程优势在于系统内核实现，劣势也在于没有系统内核支援，所有线程操作都要用户程序自己处理。线程创建、销毁、切换和调度都是用户必须考虑的问题。

##### 混合实现

​	多对多线程模型，内核线程与用户线程一起使用的方式。

### 为什么内核线程切换起来成本高？

​	内核线程调度成本主要来自用户态和内核态的状态转换。这两种状态切换的开销主要来自于响应中断、保护和恢复现场的成本。

​	代码执行需要上下文数据的支撑，上下文以程序员角度就是方法调用过程各种局部变量与资源，以线程角度来说就是方法调用栈中存储的各种信息，以操作系统硬件角度就是，存储在内存、缓存和寄存器中的一个个具体数值。

​	当中断发生，从线程A切换到线程B去执行之前，操作系统首先要把线程A的上下文数据保存好，然后把寄存器、内存分页恢复到线程B挂起状态。这种保护现场和恢复现场的工作，需要一系列在各种寄存器、缓存中来回拷贝，当然不是一个轻量级的操作。



### 协程的出现

​	协程基于线程之上，但比线程更轻量级。由程序员自己写程序来管理的轻量级线程叫协程，一个线程可以有多个协程。

​	协程特点：

- 线程切换由操作系统来调度，要从用户态切换到内核态，cpu上下文切换。而协程在单线程内实现调度，每个协程有自己的栈和寄存器。减少了上下文切换，提高了效率。
- 协程更轻量，初始一般为2k，资源占用更小
- 在同一线程上，不用多线程锁机制，效率更高
- 适用于被阻塞且要高并发，不适用于大量计算高并发。协程主要是把很多I/O操作省下来，实现了非阻塞

### 进程和线程特点总结

- 线程和进程最大区别：线程是cpu调度的基本单位，进程是资源分配的基本单位
- 进程有自己的独立地址空间，线程没有
- 同一进程下线程可共享进程内资源（全局变量、静态变量），进程之间只能通过进程间通信
- 进程切换开销大，线程相对小
- 一个进程可以拥有多个线程，一个线程只能属于一个进程

### 为什么进程切换比线程切换消耗资源更多

​	进程切换和线程切换都在内核态中完成，进程切换要使用新的地址空间，cpu上下文切换会导致发生更多的缺页中断，而线程切换虚拟地址空间相同。
---
layout:     post
title:      MySQL的ACID原则实现原理
subtitle:   概述
date:       2021-04-13
author:     QuanLi
header-img: img/post-bg-kuaidi.jpg
catalog: true
tags:
    - 数据库
---

# MySQL的ACID原则实现原理

ACID是衡量事务的四个特性：

- 原子性（Atomicity，或称不可分割性）
- 一致性（Consistency）
- 隔离性（Isolation）
- 持久性（Durability）

### 原子性

​	原子性是指一个事务的不可分割的最小单位，其中操作要么都做要么都不做。如果一个事务中的一条sql语句执行失败，则已执行的其他语句也需要回滚。

### 原子性的实现原理：undo log

​	在说明原子性原理之前，首先介绍一下MySQL的事务日志。MySQL的日志有很多种，如二进制日志、错误日志、查询日志、慢查询日志等，此外InnoDB存储引擎还提供了两种事务日志：redo log(重做日志)和undo log(回滚日志)。其中**redo log用于保证事务持久性**；**undo log则是事务原子性和隔离性实现的基础。**

​	下面说回undo log。实现原子性的关键，是当事务回滚时能够撤销所有已经成功执行的sql语句。**InnoDB实现回滚，靠的是undo log**：当事务对数据库进行修改时，InnoDB会生成对应的undo log；如果事务执行失败或调用了rollback，导致事务需要回滚，便可以利用undo log中的信息将数据回滚到修改之前的样子。

​	undo log属于逻辑日志，它记录的是sql执行相关的信息。**当发生回滚时，InnoDB会根据undo log的内容做与之前相反的工作**：对于每个insert，回滚时会执行delete；对于每个delete，回滚时会执行insert；对于每个update，回滚时会执行一个相反的update，把数据改回去。

以update操作为例：当事务执行update时，其生成的undo log中会包含被修改行的主键(以便知道修改了哪些行)、修改了哪些列、这些列在修改前后的值等信息，回滚时便可以使用这些信息将数据还原到update之前的状态。

### 持久性

​	持久性是指事务一旦提交，它对数据库的改变是永久性的，无论接下来发生什么故障。

### 持久性实现原理：redo log

#### redo log

​	redo log和undo log都属于InnoDB的事务日志。下面先聊一下redo log存在的背景。

​	InnoDB作为MySQL的存储引擎，数据是存放在磁盘中的，但如果每次读写数据都需要磁盘IO，效率会很低。为此，**InnoDB提供了缓存(Buffer Pool)，Buffer Pool中包含了磁盘中部分数据页的映射，作为访问数据库的缓冲**：当从数据库读取数据时，会首先从Buffer Pool中读取，如果Buffer Pool中没有，则从磁盘读取后放入Buffer Pool；当向数据库写入数据时，会首先写入Buffer Pool，Buffer Pool中修改的数据会定期刷新到磁盘中（这一过程称为刷脏）。

​	Buffer Pool的使用大大提高了读写数据的效率，但是也带了新的问题：如果MySQL宕机，而**此时Buffer Pool中修改的数据还没有刷新到磁盘，就会导致数据的丢失**，事务的持久性无法保证。

​	于是，redo log被引入来解决这个问题：**当数据修改时，除了修改Buffer Pool中的数据，还会在redo log记录这次操作**；当事务提交时，会调用fsync接口对redo log进行刷盘。如果MySQL宕机，重启时可以读取redo log中的数据，对数据库进行恢复。redo log采用的是WAL（Write-ahead logging，预写式日志），**所有修改先写入日志，再更新到Buffer Pool，保证了数据不会因MySQL宕机而丢失，从而满足了持久性要求。**

#### redo log与binlog不同

我们知道，在MySQL中还存在**binlog(二进制日志)也可以记录写操作并用于数据的恢复**，但二者是有着根本的不同的：

- 作用不同：redo log是用于crash recovery的，**保证MySQL宕机也不会影响持久性**；binlog是用于point-in-time recovery的，**保证服务器可以基于时间点恢复数据**，此外binlog还用于主从复制。
- 层次不同：**redo log是InnoDB存储引擎实现的**，**而binlog是MySQL的服务器层(可以参考文章前面对MySQL逻辑架构的介绍)实现的，同时支持InnoDB和其他存储引擎**。
- 内容不同：redo log是物理日志，内容基于磁盘的Page；binlog的内容是二进制的，根据binlog_format参数的不同，可能基于sql语句、基于数据本身或者二者的混合。

### 隔离性

​	隔离性是指，事务内部的操作与其他事务是隔离的，并发执行的各个事务之间不能互相干扰。

### 隔离性原理

- (一个事务)写操作对(另一个事务)写操作的影响：锁机制保证隔离性
- (一个事务)写操作对(另一个事务)读操作的影响：MVCC保证隔离性



### 一致性

​	一致性是指事务执行结束后，**数据库的完整性约束没有被破坏，事务执行的前后都是合法的数据状态。**

​	可以说，一致性是事务追求的最终目标：前面提到的原子性、持久性和隔离性，都是为了保证数据库状态的一致性。此外，除了数据库层面的保障，一致性的实现也需要应用层面进行保障。

实现一致性的措施包括：

- 保证原子性、持久性和隔离性，如果这些特性无法保证，事务的一致性也无法保证
- 数据库本身提供保障，例如不允许向整形列插入字符串值、字符串长度不能超过列的限制等
- 应用层面进行保障，例如如果转账操作只扣除转账者的余额，而没有增加接收者的余额，无论数据库实现的多么完美，也无法保证状态的一致